

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> users/router/auth.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item">mmLearnJS API</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Namespaces</h3><ul><li><a href="controllers.html">controllers</a></li><li><a href="helpers.html">helpers</a></li><li><a href="models.html">models</a></li><li><a href="routers.html">routers</a></li></ul><h3>Classes</h3><ul><li><a href="controllers.helpers.html">helpers</a></li><li><a href="controllers.users.html">users</a></li><li><a href="controllers.users.auth.html">auth</a></li><li><a href="controllers.users.usersData.html">usersData</a></li><li><a href="controllers.users.util.html">util</a></li><li><a href="controllers.users.validators.html">validators</a></li><li><a href="models.User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html#courseSchema">courseSchema</a></li><li><a href="global.html#gfs">gfs</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#updateDeletedEntriesSchema">updateDeletedEntriesSchema</a></li><li><a href="global.html#updateNewEntriesSchema">updateNewEntriesSchema</a></li><li><a href="global.html#updateNewInfoSchema">updateNewInfoSchema</a></li><li><a href="global.html#userSchema">userSchema</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>users/router/auth.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>let {
    signup, activateAccount, signin, getAuthenticatedUser,
    requireAuthentication, logout, inviteSignup, sendActivationLink,
    forgotPassword, resetPassword, userDataValidator
} = require('../controllers');
let {validate} = require('../../helpers')
/**
 * @swagger
 * tags:
 *   name: /auth/...
 *   description: >
 *     All routes and API endpoints that are related to users
 *     authentication and authorization. These routes implicitly
 *     change/create the user's data. If the user is authenticated
 *     and sends their authorization token in the request cookies
 *     on any endpoint, mentioned in this section,
 *     the server extends their session (puts new session cookie to response headers)
 *     so that it would last 10 minutes, starting from the moment when the client
 *     receives the response. If no `auth` cookie is present, nothing happens.
 */
let router = require('express').Router()

/**
 * @swagger
 * path:
 *  /auth/signup:
 *    post:
 *      summary: Creates a new user if the data in the body is valid
 *      operationId: signup
 *      tags:
 *        - "/auth/..."
 *      requestBody:
 *        required: true
 *        content:
 *          application/json:
 *            schema:
 *              type: object
 *              required:
 *                - name
 *                - email
 *                - password
 *              properties:
 *                name:
 *                  type: string
 *                email:
 *                  type: string
 *                  format: email
 *                password:
 *                  type: string
 *                  description: >
 *                    See [User schema](#/components/schemas/User) for correct password pattern
 *                teacher:
 *                  type: boolean
 *                  description: >
 *                    provide this prop if you want to register an account with the `teacher` role.
 *                    If true, provide the correct teacher password under the `teacherPassword` prop
 *                teacherPassword:
 *                  type: string
 *                  description: >
 *                    provide this password to register a teacher account.
 *                    FOR TESTING PURPOSES: currently `teacherPassword="testpass"`
 *      responses:
 *        "200":
 *          description: >
 *            Successfully created a new users. Email sent.
 *            Respond with the user's data and the confirmation
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *                  user:
 *                    $ref: '#/components/schemas/User'
 *        "400":
 *          description: >
 *            Invalid data in the request.
 *            See [User schema](#/components/schemas/User)
 *            for details about what users data should contain
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "401":
 *          description: Wrong teacher password
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "403":
 *          description: Given email is taken
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.post('/signup',
    userDataValidator(null, 'name', 'password', 'email'),
    validate,
    signup
);// TODO add tests to check if email was sent

/**
 * @swagger
 * path:
 *  /auth/invite-signup/:inviteToken:
 *    post:
 *      summary: >
 *        Creates a new user if the data in the body and in the invitation token is correct.
 *        Sends an message to the user's email address which contains the token to activate their account
 *      operationId: inviteSignup
 *      tags:
 *        - "/auth/..."
 *      parameters:
 *        - name: inviteToken
 *          in: path
 *          description: >
 *            the token that contains
 *            encrypted user data
 *          required: true
 *          type: string
 *      requestBody:
 *        required: true
 *        content:
 *          application/json:
 *            schema:
 *              type: object
 *              required:
 *                - name
 *                - password
 *              properties:
 *                name:
 *                  type: string
 *                password:
 *                  type: string
 *                  description: >
 *                    See [User schema](#/components/schemas/User) for correct password pattern
 *                teacher:
 *                  type: boolean
 *                  description: >
 *                    provide this prop if you want to register an account with the `teacher` role.
 *                    If true, provide the correct teacher password under the `teacherPassword` prop
 *                teacherPassword:
 *                  type: string
 *                  description: >
 *                    provide this password to register a teacher account.
 *                    FOR TESTING PURPOSES: currently `teacherPassword="testpass"`
 *      responses:
 *        "200":
 *          description: >
 *            Successfully created a new user. If the token contained any additional
 *            instructions, all of the necessary operations were executed. Email sent.
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *                  user:
 *                    $ref: '#/components/schemas/User'
 *        "400":
 *          description: >
 *            Invalid data in the request or in the token.
 *            See [User schema](#/components/schemas/User)
 *            for details about what users data should contain
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "401":
 *          description: Wrong token or wrong teacher password
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "403":
 *          description: Given email is taken
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.post('/invite-signup/:inviteToken',
    userDataValidator(null, 'name', 'password'),
    validate,
    inviteSignup
);// TODO add tests to check if email was sent

/**
 * @swagger
 * path:
 *  /auth/signin:
 *    post:
 *      summary: >
 *        Authenticates user, sending them a cookie in the HTTP header of the response.
 *        This cookie contains a [JWT](https://jwt.io) that has all necessary data to
 *        identify the user. This cookie should be sent back to the server
 *        every time an action with special authorization is required
 *        (e. g. enrolling in a course, changing user data)
 *      operationId: signin
 *      tags:
 *        - "/auth/..."
 *      requestBody:
 *        required: true
 *        content:
 *          application/json:
 *            schema:
 *              type: object
 *              required:
 *                - email
 *                - password
 *              properties:
 *                email:
 *                  type: string
 *                  format: email
 *                password:
 *                  type: string
 *      responses:
 *        "200":
 *          description: Successfully created a new users. Send the users and the confirmation
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *          headers:
 *            Set-Cookie:
 *              description: >
 *                Contains the `auth` cookie with the authorization token.
 *                Pass this token in requests to get authorized
 *              schema:
 *                type: string
 *                example: auth=randomjwttoken; Path=/; HttpOnly Secure SameSite=None
 *        "400":
 *          description: User with given email doesn't exist
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "401":
 *          description: Wrong password
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.post('/signin', signin);

// no need to test it, it doesn't cause errors and always does the same thing,
// it has no special request properties
/**
 * @swagger
 * path:
 *  /auth/logout:
 *    get:
 *      summary: >
 *        Clears the cookie that is responsible for authenticating the user if it is present.
 *        This is necessary, because all cookies have the
 *        [HttpOnly](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies) property
 *      tags:
 *        - "/auth/..."
 *      operationId: logout
 *      responses:
 *        "200":
 *          description: Cookies cleared successfully
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 */
router.get('/logout', logout);

/**
 * @swagger
 * path:
 *  /auth/cur-user:
 *    get:
 *      summary: >
 *        Get the current authenticated, depending on the authentication
 *        token in the `auth` cookie
 *      security:
 *        - cookieAuth: []
 *      tags:
 *        - "/auth/..."
 *      operationId: getAuthenticatedUser
 *      responses:
 *        "200":
 *          description: >
 *            The authenticated user if the authorization cookie was present
 *            in the headers, `"Not authenticated"` otherwise
 *          content:
 *            application/json:
 *              schema:
 *                oneOf:
 *                  - $ref: '#/components/schemas/User'
 *                  - type: string
 */
router.get('/cur-user', getAuthenticatedUser);

/**
 * @swagger
 * path:
 *  /auth/send-activation:
 *    post:
 *      summary: >
 *        Sends the account activation link to the authenticated user's email
 *        if their account is not yet activated
 *      security:
 *        - cookieAuth: []
 *      tags:
 *        - "/auth/..."
 *      operationId: sendActivationLink
 *      responses:
 *        "200":
 *          description: Activation link sent successfully
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *        "401":
 *          description: User is not authenticated
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "403":
 *          description: Account is already activated; No email was sent
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.post('/send-activation',//TODO finish tests, check if email is sent with sinon/or smth else
    requireAuthentication,
    sendActivationLink
)// TODO add tests to check if email was sent

/**
 * @swagger
 * path:
 *  /auth/activate/:activationToken:
 *    get:
 *      summary: >
 *        Activates the user, who is encrypted in
 *        the token in the `activationToken` param
 *      tags:
 *        - "/auth/..."
 *      parameters:
 *        - name: activationToken
 *          in: path
 *          description: >
 *            the token that contains
 *            encrypted user data
 *          required: true
 *          type: string
 *      operationId: activateAccount
 *      responses:
 *        "200":
 *          description: >
 *            Successfully activated account if it is not activated.
 *            Do nothing if account was activated beforehand.
 *            If not activated before, remove a reminder /
 *            notification to activate the account for the user
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *        "401":
 *          description: The activation token is invalid
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "404":
 *          description: User with given token could not be found
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.get('/activate/:activationToken', activateAccount);

/**
 * @swagger
 * path:
 *  /auth/forgot-password:
 *    post:
 *      summary: >
 *        Sends a message to the user's email address which contains
 *        instructions on how to reset their password
 *      tags:
 *        - "/auth/..."
 *      operationId: forgotPassword
 *      responses:
 *        "200":
 *          description: >
 *            Email with instructions sent to user
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *        "400":
 *          description: No email provided in request or any problems with request body
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "404":
 *          description: User with given email could not be found
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.post('/forgot-password', forgotPassword)// TODO add tests to check if email was sent

/**
 * @swagger
 * path:
 *  /auth/reset-password/:resetToken:
 *    post:
 *      summary: >
 *        Sets a new password for the user, whose data is encrypted in the provided token
 *      tags:
 *        - "/auth/..."
 *      operationId: resetPassword
 *      parameters:
 *        - name: resetToken
 *          in: path
 *          description: >
 *            the token that contains
 *            encrypted user data
 *          required: true
 *          type: string
 *      responses:
 *        "200":
 *          description: >
 *            Password updated successfully
 *          content:
 *            application/json:
 *              schema:
 *                type: object
 *                properties:
 *                  message:
 *                    type: string
 *        "400":
 *          description: >
 *            New password is incorrect.
 *            See [User schema](#/components/schemas/User) for correct password pattern
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "401":
 *          description: Reset token is invalid
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 *        "404":
 *          description: User with the email, provided in the token could not be found
 *          content:
 *            application/json:
 *              schema:
 *                $ref: '#/components/schemas/Error'
 */
router.post('/reset-password/:resetToken',
    userDataValidator({password: 'newPassword'}, 'password'),
    validate,
    resetPassword
)

//TODO one way to test if email is sent: create a sinon.stub which has absolutely the same code
//TODO as helpers.sendEmail. The email gets sent, check the return value of the first call of the function
//TODO via sinon.spy methods

module.exports = router;</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>

</body>
</html>
